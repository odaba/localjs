(function(){window.attachEvent("onload",function(){var z=document,r=YAHOO.util.Event,s=localJS.COM.createObject,f=LOCALJS.UI,i=LOCALJS.FILE,o=f.msgBox,k=new YAHOO.widget.Button("btnADO"),t=new YAHOO.widget.Button("btnOpenExcel");var h=i.buildPath(i.getParentFolder(i.urlToPath(z.URL)),"sample data.xls");var p=function(){var B=s("ADODB.Connection");B.Provider="Microsoft.Jet.OLEDB.4.0";B.ConnectionString="Data Source="+h+";Extended Properties=Excel 8.0;";B.Open();return B};var c=function(B){if(B){try{B.Close()}catch(C){}}};var n=function(M){var K,E,C=[];try{var J=1,L=3,D=1,G="SELECT * FROM [employee data$]";if(M){M.match(/\bsort=([^&=]+)/i);var I=RegExp.$1;M.match(/\bdir=([^&=]+)/i);var B=RegExp.$1;G+=" order by "+I+" "+B}K=p(),E=s("ADODB.Recordset"),E.Open(G,K,J,L,D);E.MoveFirst();while(!E.EOF){var F=E.Fields;C.push({name:F.Item("Name").Value,age:F.Item("Age").Value,gender:F.Item("Gender").Value,start_day:new Date(F.Item("Start_Day").Value),id:F.Item("ID").Value});E.MoveNext()}}catch(H){alert(H.name+"\n"+H.description)}c(E);c(K);return{items:C}};var u=function(B,D,L){var J,E,F=false;try{var I=1,K=3,C=1,G="SELECT * FROM [employee data$] where id = "+B;J=p();E=s("ADODB.Recordset");E.Open(G,J,I,K,C);E.MoveFirst();if(!E.EOF){E.Update(D,L);F=true}}catch(H){alert(H.name+"\n"+H.description)}c(E);c(J);return F};var A=function(B,C){return u(B.getRecord().getData("id"),B.getColumn().key,C)?C:undefined};var q,v=new YAHOO.util.FunctionDataSource(n);v.responseType=YAHOO.util.DataSource.TYPE_JSON;v.responseSchema={resultsList:"items"};var d=function(){var B={success:q.onDataReturnInitializeTable,scope:q};v.sendRequest(null,B)};var g=function(C,B,D,E){C.innerHTML=B.getData(D.key)+" 歲"};var m=function(C,B,D,E){C.innerHTML=B.getData(D.key)?"男":"女"};var j=function(D,C,E,F){var B=C.getData(E.key);D.innerHTML=B.getFullYear()+"年"+(B.getMonth()+1)+"月"+B.getDate()+"日"};var b=function(B,D,C){B=YAHOO.lang.trim(B);if(B==D){C.cancel();return undefined}if(0==B.length){alert("姓名不能為空。");return undefined}return A(C,B)};var y=function(B,D,C){B=YAHOO.lang.trim(B);if(B==D){C.cancel();return undefined}if(B.search(/[^\d]/)>=0||1*B<=0){alert("請填入有效的正整數。");return undefined}return A(C,1*B)};var e=function(B,D,C){B=YAHOO.lang.trim(B);if("男"==B){B=1}else{if("女"==B){B=0}else{return undefined}}if(B==D){C.cancel();return undefined}return A(C,B)};var x=function(B,E,C){var F=new Date(B);if(0==F-new Date(E)){C.cancel();return undefined}var D=F.getMonth()+1;return A(C,D+"/"+F.getDate()+"/"+F.getFullYear())?B:undefined};var l=["1","2","3","4","5","6","7","8","9","10","11","12"],a=["日","一","二","三","四","五","六"];calendar_cfg={show_week_header:true,MY_LABEL_YEAR_SUFFIX:"年",MY_LABEL_MONTH_SUFFIX:"月",MONTHS_SHORT:l,MONTHS_LONG:l,WEEKDAYS_1CHAR:a,WEEKDAYS_SHORT:a,WEEKDAYS_MEDIUM:a,WEEKDAYS_LONG:a,MY_LABEL_YEAR_POSITION:1,MY_LABEL_MONTH_POSITION:2,navigator:{strings:{month:"請選擇月份",year:"請輸入年份",submit:"轉到",cancel:"取消",invalidYear:"請輸入有效的年份。"}}};var w=[{key:"id",label:"ID",resizeable:true,sortable:true},{key:"name",label:"姓名",resizeable:true,sortable:true,editor:new YAHOO.widget.TextboxCellEditor({validator:b,LABEL_SAVE:"保存",LABEL_CANCEL:"取消"})},{key:"age",label:"年齡",resizeable:true,formatter:g,sortable:true,editor:new YAHOO.widget.TextboxCellEditor({validator:y,LABEL_SAVE:"保存",LABEL_CANCEL:"取消"})},{key:"gender",label:"性别",resizeable:true,sortable:true,formatter:m,editor:new YAHOO.widget.RadioCellEditor({radioOptions:["男","女"],validator:e,disableBtns:true})},{key:"start_day",label:"入職日期",resizeable:true,sortable:true,formatter:j,editor:new YAHOO.widget.DateCellEditor({calendarOptions:calendar_cfg,validator:x,LABEL_SAVE:"保存",LABEL_CANCEL:"取消"})}];k.on("click",function(){try{if(q){d()}else{o("下面將用ADO打開"+h);q=new YAHOO.widget.ScrollingDataTable(z.getElementById("dataTable"),w,v,{width:"740px",height:"280px",dynamicData:true});var D=function(E){var F=E.target;if(YAHOO.util.Dom.hasClass(F,"yui-dt-editable")){this.highlightCell(F)}};var B=function(F){var J=F.editor,M=J.getRecord(),I=J.getColumn();if(I){if("start_day"==I.key){var H=J.calendar,E=M.getData(I.key);H.select(E);H.cfg.setProperty("pagedate",E);H.render()}else{if("gender"==I.key){var L=M.getData(I.key),K=J.radios;for(var G=0;G<K.length;++G){K[G].checked=G!=L}}}}};q.subscribe("cellMouseoverEvent",D);q.subscribe("cellMouseoutEvent",q.onEventUnhighlightCell);q.subscribe("cellClickEvent",q.onEventShowCellEditor);q.subscribe("editorShowEvent",B);t.setStyle("visibility","visible");t.set("label","在Excel中打開 "+h);t.set("disabled",false);t.focus();t.on("click",function(){i.exec(h);o("在本窗口內編輯表格內容，Excel 中的內容會實時改變。")});o("點擊 表頭 可以排序；\n點擊 內容 可以編輯。 \n注意 修改日期時 彈出的對話框 已經本地化了。")}}catch(C){alert(C.name+"\n"+C.description)}});k.set("disabled",false);k.focus()})})();